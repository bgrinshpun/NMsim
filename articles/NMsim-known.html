<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="NMsim">
<title>Simulate Known Subjects Using Emperical Bayes Estimates (Etas/Phis) • NMsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulate Known Subjects Using Emperical Bayes Estimates (Etas/Phis)">
<meta property="og:description" content="NMsim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.960</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-vignettes">Vignettes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-vignettes">
    <a class="dropdown-item" href="../articles/NMsim-basics.html">Simulation of new subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a>
    <a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a>
    <a class="dropdown-item" href="../articles/NMsim-known.html">Simulate known subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-TypSubj.html">Simulate typical subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with parameter uncertainty</a>
    <a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Creation of Simulation Data Sets</a>
    <a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with residual variability</a>
    <a class="dropdown-item" href="../articles/NMsim-varyPars.html">Varying parameter values</a>
    <a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse simulated subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Simulate Known Subjects Using Emperical Bayes Estimates (Etas/Phis)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMsim/blob/HEAD/vignettes/NMsim-known.Rmd" class="external-link"><code>vignettes/NMsim-known.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-known.Rmd</code></div>
    </div>

    
    
<p>Built 2024-06-26 using NMsim 0.1.0.960.</p>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<p>This vignettes aims at enabling you to use <code>NMsim</code> for the
following purposes</p>
<ul>
<li>Simualation of known subjects (estimated random effects),</li>
</ul>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>You should have configured <code>NMsim</code> with the path to the
Nonmem installation and maybe also PSN (optional). See <a href="https://philipdelff.github.io/NMsim/articles/NMsim-config.html"><code>NMsim-config.html</code></a>.
Don’t worry - it is very easy.</p>
<p>You should be familiar with basic <code>NMsim</code> arguments as
described in <a href="https://philipdelff.github.io/NMsim/articles/NMsim-basics.html"><code>NMsim-basics.html</code></a>.
In that vignette you should have learned to use the default simulation
method. This vignette will be using the same model and simulation input
data to demonstrate how to use additional methods and features of
<code>NMsim</code>.</p>
</div>
<div class="section level2">
<h2 id="simulation-of-known-subjects">Simulation of known subjects<a class="anchor" aria-label="anchor" href="#simulation-of-known-subjects"></a>
</h2>
<p>We sometimes want to simulate the already observed subjects. This
means we want to reuse the estimated random effects (ETA’s) given the
subject ID’s. <code>NMsim</code> has a method for this called
<code>NMsim_known</code>. The restriction is that all subjects (values
of <code>ID</code>) in the simulation input data must have been used in
the estimation input data.</p>
<p>Let’s think about that one more time before we go on. For
<code>NMsim_known</code> to work, <code>ID</code> values in the
simulation data set must be identical to <code>ID</code> values used in
the estimation. This is how <code>NMsim_known</code> will find the EBE’s
(ETAs) that define the subject. For models estimated with FOCEI,
<code>NMsim_known</code> will take the ETAs from the <code>.phi</code>
file produced by Nonmem. For SAEM/IMP-based estimation this file cannot
be used, and the user must have stored the ETAs in output table files
for the method to work. It does not matter where in the table files they
are, they just all need to be there. You can write all of them like it
is done in the example model provided with <code>NMsim</code> called
<code>xgxr032.mod</code>.</p>
<pre><code>$TABLE ETAS(1:LAST) NOAPPEND NOPRINT FILE=xgxr032_etas.txt</code></pre>
<p>So a “subject” essentially means a set of ETAs. Covariates must still
be provided in the input data set and can be modified if wanted. Notice,
<code>NMsim_known</code> does nothing to restore covariates - you must
define covariates in input data as needed.</p>
</div>
<div class="section level2">
<h2 id="individual-dosing-history-sample-times-or-both">Individual dosing history, sample times or both<a class="anchor" aria-label="anchor" href="#individual-dosing-history-sample-times-or-both"></a>
</h2>
<p>Individual simulations are useful for several purposes. Examples</p>
<ul>
<li><p>Reuse individual dosing history and use a new common sample
scheme. This could be for homogeneous evaluation of exposure metrics
such as Cmax, AUC, or just to show concentration-time profiles at
identical sampling times based on a model estimated on data with
heterogeneos sampling. Currently, there is no example of this in this
vignette but see the other examples, and it should be pretty clear how
to do this.</p></li>
<li><p>Reuse dosing history and use individual sampling scheme from a
different data set, e.g. PD.</p></li>
<li><p>Simulate a new common dosing and sampling scheme to simulate
already observed subjects on a new regimen. This is sometimes done if
for one reason or the other the model is not considered reliable for
simulation of new subjects but the individual parameter estimates are
trusted.</p></li>
<li><p>Reuse a simulated population. One may prefer to reuse the same
simulated subjects in multiple simulations for reproducibility and to
have all difference between say simulation results of different regimens
be driven by differences in the regimen, and not in the populations.
This use of <code>NMsim_known</code> is on the todo list tog get it’s
own vignette <a href="https://philipdelff.github.io/NMsim/articles/NMsim-ReuseSimSubjects.html">here</a>.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="simulate-known-subjects-on-a-new-dosing-regimen-and-new-sample-schedule">Simulate known subjects on a new dosing regimen and new sample
schedule<a class="anchor" aria-label="anchor" href="#simulate-known-subjects-on-a-new-dosing-regimen-and-new-sample-schedule"></a>
</h2>
<p>The following code takes an already created simulation data set with
a single ID, and merges all other columns than <code>ID</code> onto the
observed <code>ID</code>s. That gives the same simulation data for all
subjects.</p>
<p>First thing, we decide on a model (an input control stream of an
estimated model) to use for the example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr021.mod"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span></code></pre></div>
<p>Simulation with known ETA values is only possible through NMsim’s
internal Nonmem execution method. That means, we need to provide the
path to the Nonmem executable. Also, We configure locations where
<code>NMsim</code> will store and run Nonmem control streams
(<code>dir.sims</code>) and where it will save the final results file.
Finally, because this vignette uses some <code>data.table</code> code we
tell <code>NMsim</code> to return <code>data.table</code>s.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">NMdataConf</span><span class="op">(</span>path.nonmem<span class="op">=</span><span class="st">"/opt/NONMEM/nm75/run/nmfe75"</span>,</span>
<span>           dir.sims<span class="op">=</span><span class="st">"simulate-tmp"</span>,</span>
<span>           dir.res<span class="op">=</span><span class="st">"simulate-results"</span>,</span>
<span>           as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## read model results just to extract the observed ID's</span></span>
<span><span class="va">res.mod</span> <span class="op">&lt;-</span> <span class="fu">NMscanData</span><span class="op">(</span><span class="va">file.mod</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ID<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">res.mod</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Repeat the simulation data set for each ID and order accordingly</span></span>
<span><span class="va">dat.sim.known</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">ids</span>,</span>
<span>                       <span class="va">dat.sim</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.sim</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span>,with<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span>                       <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.known</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span>
<span><span class="co">## check data</span></span>
<span><span class="fu">NMcheckData</span><span class="op">(</span><span class="va">dat.sim.known</span>,type.data<span class="op">=</span><span class="st">"sim"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simres.known</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                      data<span class="op">=</span><span class="va">dat.sim.known</span>,</span>
<span>                      method.sim<span class="op">=</span><span class="va">NMsim_known</span>,</span>
<span>                      table.vars<span class="op">=</span><span class="st">"PRED IPRED CL V2 KA"</span>,</span>
<span>                      name.sim<span class="op">=</span><span class="st">"known1"</span></span>
<span>                      <span class="op">)</span></span></code></pre></div>
<p>And the simulation results are plotted for each subject.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.known</span><span class="op">)</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">]</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">IPRED</span>,colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-known_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<!-- Show a plot of the individual parameters in estimate and in sim -->
<div class="section level3">
<h3 id="simulate-individual-dosing-history-at-new-individual-sampling-times-for-a-pkpd-dataset">Simulate individual dosing history at new individual sampling times
for a PK/PD dataset<a class="anchor" aria-label="anchor" href="#simulate-individual-dosing-history-at-new-individual-sampling-times-for-a-pkpd-dataset"></a>
</h3>
<p>We want to plot some PD data angainst PK. However, PD was sampled
differnetly than PK, and we want to evaluate the individual predictions
of the PK model at the individual PD samplng times - reusing the
individual dosing history.</p>
<p>Reading some example PD data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/data/xgxr_pd.rds"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## some code below makes use of data.table features so we make it a data.table</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">pd</span><span class="op">)</span></span></code></pre></div>
<p>For a PK model without time-varying covariates, suggested steps to
generate the data for the simulation are:</p>
<ul>
<li>Take dose records from PK model estimation input data
(<code>pkdos</code>). Just keep necessary columns like <code>ID</code>,
<code>TIME</code>, <code>EVID</code>, <code>CMT</code>,
<code>AMT</code>, <code>ADDL</code>, <code>II</code>, and any necessary
covariates</li>
<li>Take PD data observation records (<code>pdsamples</code>). Just keep
<code>ID</code>, <code>TIME</code>, and set <code>EVID=2</code>.</li>
<li>Add a unique row identifier to <code>pdsamples</code> (an integer
row counter, like <code>ROW=1:nrow(pdsamples)</code>)</li>
<li>Stack (<code>rbind</code> for data.tables or <code>bind_rows</code>
in tidyverse) <code>pkdos</code> and <code>pdsamples</code> to one data
set (<code>pdsim</code>)</li>
<li>In <code>pdsim</code>, set <code>DV=NA</code>
</li>
<li>Sort <code>pdsim</code> at least by <code>ID</code>,
<code>TIME</code> and <code>EVID</code>. There could be more depending
on trial design</li>
</ul>
<p>In case of time-varying covariates, you can keep all data records
from the PK data (without <code>DV</code>), but change observation
records to simulation records (<code>EVID=2</code> instead of
<code>EVID=0</code>).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Take dose records from PK model estimation input data</span></span>
<span><span class="va">pkres</span> <span class="op">&lt;-</span> <span class="fu">NMscanData</span><span class="op">(</span><span class="va">file.mod</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pkdos</span> <span class="op">&lt;-</span> <span class="va">pkres</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span>, <span class="va">TIME</span>, <span class="va">EVID</span>, <span class="va">CMT</span>, <span class="va">AMT</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## Take PD data observation records (`pdsamples`)</span></span>
<span><span class="va">pdsamples</span> <span class="op">&lt;-</span> <span class="va">pd</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">LIDV</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## Stack `pkdos` and `pdsamples` to one data set (`pdsim`)</span></span>
<span><span class="va">pdsim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pkdos</span>,<span class="va">pdsamples</span>,fill<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## Nonmem needs a DV column to run</span></span>
<span><span class="va">pdsim</span><span class="op">[</span>,<span class="va">DV</span><span class="op">:=</span><span class="cn">NA</span><span class="op">]</span></span>
<span><span class="co">## only include subjects that were included in the PK model</span></span>
<span><span class="va">pdsim</span> <span class="op">&lt;-</span> <span class="va">pdsim</span><span class="op">[</span><span class="va">ID</span><span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span><span class="va">pkres</span><span class="op">$</span><span class="va">ID</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">pdsim</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span></code></pre></div>
<p>Then run <code>NMsim</code> like this. We are renaming the prediction
columns using Nonmem <code>$TABLE</code> statement not to confuse PK
predictions and PD predictions.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.pksim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span>,</span>
<span>                      data<span class="op">=</span><span class="va">pdsim</span>,</span>
<span>                      name.sim<span class="op">=</span><span class="st">"pkpd"</span>,</span>
<span>                      method.sim<span class="op">=</span><span class="va">NMsim_known</span>,</span>
<span>                      table.vars<span class="op">=</span><span class="st">"PKIPRED=IPRED PKPRED=PRED"</span></span>
<span>                      <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">simres.pksim</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LIDV</span><span class="op">)</span><span class="op">&amp;</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">PKIPRED</span><span class="op">)</span><span class="op">]</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">PKIPRED</span>,<span class="va">LIDV</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Individual PK prediction"</span>,y<span class="op">=</span><span class="st">"Observed PD value"</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-known_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
